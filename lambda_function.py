import boto3
import json

path_for_converted_images = "text-documents/" # TODO: Move all configs to separate config file
response_to_extract = {'DocumentMetadata': {'Pages': 1}, 'Blocks': [{'BlockType': 'PAGE', 'Geometry': {'BoundingBox': {'Width': 0.9988558292388916, 'Height': 0.9901960492134094, 'Left': 0.0, 'Top': 0.0}, 'Polygon': [{'X': 0.0, 'Y': 0.0}, {'X': 0.9988558292388916, 'Y': 0.0}, {'X': 0.9988558292388916, 'Y': 0.9901960492134094}, {'X': 0.0, 'Y': 0.9901960492134094}]}, 'Id': '352e02ff-f63a-47b3-9c06-df139676d3aa', 'Relationships': [{'Type': 'CHILD', 'Ids': ['a24d1584-17db-4c32-bf6c-615d2e20d181', '586dd113-1a3a-47c3-9ed6-1d84647c118b']}]}, {'BlockType': 'LINE', 'Confidence': 99.89667510986328, 'Text': 'Dhirender Singh 5:12 PM', 'Geometry': {'BoundingBox': {'Width': 0.32871976494789124, 'Height': 0.31440088152885437, 'Left': 0.013307432644069195, 'Top': 0.10809963941574097}, 'Polygon': [{'X': 0.013307432644069195, 'Y': 0.10809963941574097}, {'X': 0.3420271873474121, 'Y': 0.10809963941574097}, {'X': 0.3420271873474121, 'Y': 0.42250052094459534}, {'X': 0.013307432644069195, 'Y': 0.42250052094459534}]}, 'Id': 'a24d1584-17db-4c32-bf6c-615d2e20d181', 'Relationships': [{'Type': 'CHILD', 'Ids': ['d35f030b-d9ab-4125-a972-7ecb6be8dac0', '8282242b-5245-4649-a7b5-d8d8ccf58596', '2755024f-6cf7-4bd6-b388-e7fec7ba92b3', 'bef75e1a-c712-404b-ab44-dd75bd9f360e']}]}, {'BlockType': 'LINE', 'Confidence': 99.81604766845703, 'Text': 'fyi. you are okay to take off for next week.. Jay confirmed yesterday', 'Geometry': {'BoundingBox': {'Width': 0.9553474187850952, 'Height': 0.3349093794822693, 'Left': 0.0110173299908638, 'Top': 0.46383097767829895}, 'Polygon': [{'X': 0.0110173299908638, 'Y': 0.46383097767829895}, {'X': 0.9663647413253784, 'Y': 0.46383097767829895}, {'X': 0.9663647413253784, 'Y': 0.7987403869628906}, {'X': 0.0110173299908638, 'Y': 0.7987403869628906}]}, 'Id': '586dd113-1a3a-47c3-9ed6-1d84647c118b', 'Relationships': [{'Type': 'CHILD', 'Ids': ['77557695-f102-408a-8c4d-9afc96a56830', 'd439c6e6-1764-4c90-9226-e31174d52328', '8bc8fe00-662d-4521-a513-dbf5f4839b76', 'c884320c-3e18-45a2-89a0-e07432ea9993', '6d616349-c994-48b1-a8f2-783111704059', '2463770d-848f-47ef-99b8-394834c97b17', '9771e7ce-856d-4aed-810b-edf28336ace1', 'fd00b4d7-6bd6-4b7b-b1c8-18183c78f11d', '45fcee7b-8c5b-49aa-a1e9-fba2523b6ce7', '1bd8312f-7e77-4a32-b7e9-9a801a5be0fe', '463e0386-0096-41f2-a4d2-00f8c7e44008', '6913e80f-75e9-43a5-b59a-4d29b9c0c7cf', 'dfeaf7ba-2c8c-4a39-9e1c-3511231b4145']}]}, {'BlockType': 'WORD', 'Confidence': 99.97450256347656, 'Text': 'Dhirender', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.1312267780303955, 'Height': 0.2585258185863495, 'Left': 0.013307432644069195, 'Top': 0.10809963941574097}, 'Polygon': [{'X': 0.013307432644069195, 'Y': 0.10809963941574097}, {'X': 0.14453420042991638, 'Y': 0.10809963941574097}, {'X': 0.14453420042991638, 'Y': 0.36662545800209045}, {'X': 0.013307432644069195, 'Y': 0.36662545800209045}]}, 'Id': 'd35f030b-d9ab-4125-a972-7ecb6be8dac0'}, {'BlockType': 'WORD', 'Confidence': 99.93366241455078, 'Text': 'Singh', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.07666654884815216, 'Height': 0.3116287589073181, 'Left': 0.14506833255290985, 'Top': 0.1108717992901802}, 'Polygon': [{'X': 0.14506833255290985, 'Y': 0.1108717992901802}, {'X': 0.221734881401062, 'Y': 0.1108717992901802}, {'X': 0.221734881401062, 'Y': 0.4225005507469177}, {'X': 0.14506833255290985, 'Y': 0.4225005507469177}]}, 'Id': '8282242b-5245-4649-a7b5-d8d8ccf58596'}, {'BlockType': 'WORD', 'Confidence': 99.82503509521484, 'Text': '5:12', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.05622600018978119, 'Height': 0.25984880328178406, 'Left': 0.23892520368099213, 'Top': 0.10862713307142258}, 'Polygon': [{'X': 0.23892520368099213, 'Y': 0.10862713307142258}, {'X': 0.2951512038707733, 'Y': 0.10862713307142258}, {'X': 0.2951512038707733, 'Y': 0.36847594380378723}, {'X': 0.23892520368099213, 'Y': 0.36847594380378723}]}, 'Id': '2755024f-6cf7-4bd6-b388-e7fec7ba92b3'}, {'BlockType': 'WORD', 'Confidence': 99.8534927368164, 'Text': 'PM', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.04454255849123001, 'Height': 0.2530527710914612, 'Left': 0.2974846363067627, 'Top': 0.11014875769615173}, 'Polygon': [{'X': 0.2974846363067627, 'Y': 0.11014875769615173}, {'X': 0.3420271873474121, 'Y': 0.11014875769615173}, {'X': 0.3420271873474121, 'Y': 0.3632015287876129}, {'X': 0.2974846363067627, 'Y': 0.3632015287876129}]}, 'Id': 'bef75e1a-c712-404b-ab44-dd75bd9f360e'}, {'BlockType': 'WORD', 'Confidence': 99.02117156982422, 'Text': 'fyi.', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.04690777510404587, 'Height': 0.33176320791244507, 'Left': 0.0110173299908638, 'Top': 0.46383097767829895}, 'Polygon': [{'X': 0.0110173299908638, 'Y': 0.46383097767829895}, {'X': 0.05792510509490967, 'Y': 0.46383097767829895}, {'X': 0.05792510509490967, 'Y': 0.7955941557884216}, {'X': 0.0110173299908638, 'Y': 0.7955941557884216}]}, 'Id': '77557695-f102-408a-8c4d-9afc96a56830'}, {'BlockType': 'WORD', 'Confidence': 99.9341812133789, 'Text': 'you', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.059231191873550415, 'Height': 0.2752053439617157, 'Left': 0.059728365391492844, 'Top': 0.5217210650444031}, 'Polygon': [{'X': 0.059728365391492844, 'Y': 0.5217210650444031}, {'X': 0.11895956099033356, 'Y': 0.5217210650444031}, {'X': 0.11895956099033356, 'Y': 0.7969263792037964}, {'X': 0.059728365391492844, 'Y': 0.7969263792037964}]}, 'Id': 'd439c6e6-1764-4c90-9226-e31174d52328'}, {'BlockType': 'WORD', 'Confidence': 99.98528289794922, 'Text': 'are', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.04866233840584755, 'Height': 0.21621009707450867, 'Left': 0.12383514642715454, 'Top': 0.5250824689865112}, 'Polygon': [{'X': 0.12383514642715454, 'Y': 0.5250824689865112}, {'X': 0.1724974811077118, 'Y': 0.5250824689865112}, {'X': 0.1724974811077118, 'Y': 0.7412925958633423}, {'X': 0.12383514642715454, 'Y': 0.7412925958633423}]}, 'Id': '8bc8fe00-662d-4521-a513-dbf5f4839b76'}, {'BlockType': 'WORD', 'Confidence': 99.9686508178711, 'Text': 'okay', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.07211987674236298, 'Height': 0.3281369209289551, 'Left': 0.1762116700410843, 'Top': 0.47060349583625793}, 'Polygon': [{'X': 0.1762116700410843, 'Y': 0.47060349583625793}, {'X': 0.24833156168460846, 'Y': 0.47060349583625793}, {'X': 0.24833156168460846, 'Y': 0.7987404465675354}, {'X': 0.1762116700410843, 'Y': 0.7987404465675354}]}, 'Id': 'c884320c-3e18-45a2-89a0-e07432ea9993'}, {'BlockType': 'WORD', 'Confidence': 99.9832534790039, 'Text': 'to', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.03536731004714966, 'Height': 0.25186726450920105, 'Left': 0.2504693567752838, 'Top': 0.48985522985458374}, 'Polygon': [{'X': 0.2504693567752838, 'Y': 0.48985522985458374}, {'X': 0.28583666682243347, 'Y': 0.48985522985458374}, {'X': 0.28583666682243347, 'Y': 0.7417224645614624}, {'X': 0.2504693567752838, 'Y': 0.7417224645614624}]}, 'Id': '6d616349-c994-48b1-a8f2-783111704059'}, {'BlockType': 'WORD', 'Confidence': 99.94881439208984, 'Text': 'take', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.06541761755943298, 'Height': 0.26399895548820496, 'Left': 0.28927522897720337, 'Top': 0.4780041575431824}, 'Polygon': [{'X': 0.28927522897720337, 'Y': 0.4780041575431824}, {'X': 0.35469284653663635, 'Y': 0.4780041575431824}, {'X': 0.35469284653663635, 'Y': 0.7420030832290649}, {'X': 0.28927522897720337, 'Y': 0.7420030832290649}]}, 'Id': '2463770d-848f-47ef-99b8-394834c97b17'}, {'BlockType': 'WORD', 'Confidence': 99.93684387207031, 'Text': 'off', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.045399341732263565, 'Height': 0.27565523982048035, 'Left': 0.3589836359024048, 'Top': 0.4660078287124634}, 'Polygon': [{'X': 0.3589836359024048, 'Y': 0.4660078287124634}, {'X': 0.40438297390937805, 'Y': 0.4660078287124634}, {'X': 0.40438297390937805, 'Y': 0.7416630983352661}, {'X': 0.3589836359024048, 'Y': 0.7416630983352661}]}, 'Id': '9771e7ce-856d-4aed-810b-edf28336ace1'}, {'BlockType': 'WORD', 'Confidence': 99.99382019042969, 'Text': 'for', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.04689693823456764, 'Height': 0.2671442925930023, 'Left': 0.4051717519760132, 'Top': 0.4714881181716919}, 'Polygon': [{'X': 0.4051717519760132, 'Y': 0.4714881181716919}, {'X': 0.4520686864852905, 'Y': 0.4714881181716919}, {'X': 0.4520686864852905, 'Y': 0.7386323809623718}, {'X': 0.4051717519760132, 'Y': 0.7386323809623718}]}, 'Id': 'fd00b4d7-6bd6-4b7b-b1c8-18183c78f11d'}, {'BlockType': 'WORD', 'Confidence': 99.96946716308594, 'Text': 'next', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.06710129976272583, 'Height': 0.2479749321937561, 'Left': 0.45464402437210083, 'Top': 0.4916342794895172}, 'Polygon': [{'X': 0.45464402437210083, 'Y': 0.4916342794895172}, {'X': 0.5217453241348267, 'Y': 0.4916342794895172}, {'X': 0.5217453241348267, 'Y': 0.7396091818809509}, {'X': 0.45464402437210083, 'Y': 0.7396091818809509}]}, 'Id': '45fcee7b-8c5b-49aa-a1e9-fba2523b6ce7'}, {'BlockType': 'WORD', 'Confidence': 99.05215454101562, 'Text': 'week..', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.08764039725065231, 'Height': 0.2610324025154114, 'Left': 0.5239164233207703, 'Top': 0.4752868711948395}, 'Polygon': [{'X': 0.5239164233207703, 'Y': 0.4752868711948395}, {'X': 0.6115568280220032, 'Y': 0.4752868711948395}, {'X': 0.6115568280220032, 'Y': 0.7363193035125732}, {'X': 0.5239164233207703, 'Y': 0.7363193035125732}]}, 'Id': '1bd8312f-7e77-4a32-b7e9-9a801a5be0fe'}, {'BlockType': 'WORD', 'Confidence': 99.93824005126953, 'Text': 'Jay', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.050002869218587875, 'Height': 0.3095959722995758, 'Left': 0.6193645596504211, 'Top': 0.4810717701911926}, 'Polygon': [{'X': 0.6193645596504211, 'Y': 0.4810717701911926}, {'X': 0.6693674325942993, 'Y': 0.4810717701911926}, {'X': 0.6693674325942993, 'Y': 0.790667712688446}, {'X': 0.6193645596504211, 'Y': 0.790667712688446}]}, 'Id': '463e0386-0096-41f2-a4d2-00f8c7e44008'}, {'BlockType': 'WORD', 'Confidence': 99.95182800292969, 'Text': 'confirmed', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.14641708135604858, 'Height': 0.2686847448348999, 'Left': 0.6741837859153748, 'Top': 0.47172433137893677}, 'Polygon': [{'X': 0.6741837859153748, 'Y': 0.47172433137893677}, {'X': 0.8206008672714233, 'Y': 0.47172433137893677}, {'X': 0.8206008672714233, 'Y': 0.7404090762138367}, {'X': 0.6741837859153748, 'Y': 0.7404090762138367}]}, 'Id': '6913e80f-75e9-43a5-b59a-4d29b9c0c7cf'}, {'BlockType': 'WORD', 'Confidence': 99.92491912841797, 'Text': 'yesterday', 'TextType': 'PRINTED', 'Geometry': {'BoundingBox': {'Width': 0.14285920560359955, 'Height': 0.3162774443626404, 'Left': 0.8235056400299072, 'Top': 0.47938674688339233}, 'Polygon': [{'X': 0.8235056400299072, 'Y': 0.47938674688339233}, {'X': 0.966364860534668, 'Y': 0.47938674688339233}, {'X': 0.966364860534668, 'Y': 0.7956641912460327}, {'X': 0.8235056400299072, 'Y': 0.7956641912460327}]}, 'Id': 'dfeaf7ba-2c8c-4a39-9e1c-3511231b4145'}], 'DetectDocumentTextModelVersion': '1.0', 'ResponseMetadata': {'RequestId': '51ada4b7-1a03-4cdc-9c49-815bef21afca', 'HTTPStatusCode': 200, 'HTTPHeaders': {'x-amzn-requestid': '51ada4b7-1a03-4cdc-9c49-815bef21afca', 'content-type': 'application/x-amz-json-1.1', 'content-length': '10347', 'date': 'Mon, 01 Feb 2021 09:39:01 GMT'}, 'RetryAttempts': 0}}

# lambda tmp has 512 MB space

def lambda_handler(event, context=True):
    body = eval(event['Records'][0]['body'])
    bucket = body['Records'][0]['s3']['bucket']['name']
    s3_object = body['Records'][0]['s3']['object']['key']
    file_name = s3_object.split('/')[-1]
    s3_download(bucket, s3_object, file_name)
    output_file = pic_to_text(file_name)
    #s3_upload(bucket, output_file)

def s3_download(bucket, s3_object, file_name):
    s3 = boto3.client('s3')
    s3.download_file(bucket, s3_object, file_name)

def s3_upload(bucket, file_name):
    s3 = boto3.client('s3')
    s3.upload_file(file_name, bucket, f"{path_for_converted_images}{file_name}")

def pic_to_text(file_name):
    client = boto3.client('textract')
    picture = open(file_name, "rb")
    picture_bytes = bytearray(picture.read())
    picture.close()
    '''response = client.detect_document_text(
        Document={
            'Bytes': picture_bytes
        }
    )'''
    response = response_to_extract
    print(response)

if __name__ == "__main__":
    lambda_handler(event={'Records': [{'messageId': '5667d277-e288-4cd4-b8cb-3ac7e79cf55e', 'receiptHandle': 'AQEBMrLQ9YsHH4qzEwoQwxmZsxsSnCp9vA1M1sElOQ6qo9OZfONPLcVq6Y5JfaZkvZD4hoXMYL69DQSMa3c8PxOY+P7N2tZm9gYTqUhabnmlDHPBZ0civ+HUe1aQm+kEHZWB+manTBOzg8GEnisjnYjh71Cc0FJxnYGUOB0GAjPK3mbK+ON2Dk/RN+LRKjQAllxRsfI05dHi0gMiNw9bbMUa8JXGypr08fR904KRL5Rp93g4kpDsxbhyzJJowL8hGj+OJRRfx4iVzxKbS6L1XjMwd5IJbzU3OdBTeHl0/SabXjMPfnX0SKAx0HXvW7jSlTBCEv+Mx5wbUee+Xxp5a6ERVg9A5nqpITX2j5x58+exajXcq57b22CSL8Xw1yAyUdSX', 'body': '{"Records":[{"eventVersion":"2.1","eventSource":"aws:s3","awsRegion":"eu-west-1","eventTime":"2021-02-01T09:12:06.914Z","eventName":"ObjectCreated:Put","userIdentity":{"principalId":"A37XF8K5LN9W2M"},"requestParameters":{"sourceIPAddress":"217.21.56.15"},"responseElements":{"x-amz-request-id":"E31492BD4045758B","x-amz-id-2":"rXvZVPvPuj32tQeSlY2YZylJtltUHPlWGtlTyQXao7zZ6gGX7t8HwAZNdZo3fZ/lx31O8t2gRg55aOf+lkvONuzDyEBK4/sf"},"s3":{"s3SchemaVersion":"1.0","configurationId":"add_message_to_queue","bucket":{"name":"max2021videocoder","ownerIdentity":{"principalId":"A37XF8K5LN9W2M"},"arn":"arn:aws:s3:::max2021videocoder"},"object":{"key":"images-to-extract/approve.JPG","size":12626,"eTag":"c2d2e8c59fcb289ee2783016a92acb11","sequencer":"006017C5E97DC87146"}}}]}', 'attributes': {'ApproximateReceiveCount': '1', 'SentTimestamp': '1612170730640', 'SenderId': 'AIDAJQOC3SADRY5PEMBNW', 'ApproximateFirstReceiveTimestamp': '1612170730645'}, 'messageAttributes': {}, 'md5OfBody': 'f4d9bcd3bc81974636c51b6896ce90a4', 'eventSource': 'aws:sqs', 'eventSourceARN': 'arn:aws:sqs:eu-west-1:673907469822:QueueOfVideos', 'awsRegion': 'eu-west-1'}]})